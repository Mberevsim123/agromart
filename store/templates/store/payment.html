{% extends 'store/base.html' %}
{% load static %}

{% block title %}Payment - Agromart{% endblock %}

{% block content %}
<div class="card max-w-4xl mx-auto p-6">
    <h2 class="text-2xl font-semibold mb-4">Payment for Order #{{ order.id }}</h2>
    {% if messages %}
        {% for message in messages %}
            <div class="alert p-4 mb-4 rounded {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    {% if order %}
        <p class="mb-4">Total Amount: ${{ order.total_price|floatformat:2 }}</p>
        <form method="post" class="space-y-4">
            {% csrf_token %}
            <div class="mb-4">
                <h3 class="text-lg font-semibold mb-2">Select Payment Method</h3>
                {{ form.payment_method }}
            </div>
            <div id="card-fields" class="payment-fields hidden space-y-2">
                <div>
                    <label for="{{ form.card_number.id_for_label }}" class="block text-sm font-medium text-gray-700">Card Number</label>
                    {{ form.card_number }}
                    {{ form.card_number.errors }}
                </div>
                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="{{ form.card_expiry.id_for_label }}" class="block text-sm font-medium text-gray-700">Expiry (MM/YY)</label>
                        {{ form.card_expiry }}
                        {{ form.card_expiry.errors }}
                    </div>
                    <div class="w-1/2">
                        <label for="{{ form.card_cvc.id_for_label }}" class="block text-sm font-medium text-gray-700">CVC</label>
                        {{ form.card_cvc }}
                        {{ form.card_cvc.errors }}
                    </div>
                </div>
            </div>
            <div id="bank-transfer-fields" class="payment-fields hidden space-y-2">
                <div>
                    <label for="{{ form.iban.id_for_label }}" class="block text-sm font-medium text-gray-700">IBAN</label>
                    {{ form.iban }}
                    {{ form.iban.errors }}
                </div>
                <p class="text-sm text-gray-500">Bank transfer instructions will be provided after submission.</p>
            </div>
            <div id="sdd-fields" class="payment-fields hidden space-y-2">
                <div>
                    <label for="{{ form.iban.id_for_label }}" class="block text-sm font-medium text-gray-700">IBAN</label>
                    {{ form.iban }}
                    {{ form.iban.errors }}
                </div>
                <div>
                    {{ form.sdd_mandate }}
                    <label for="{{ form.sdd_mandate.id_for_label }}" class="text-sm font-medium text-gray-700">Authorize SEPA Direct Debit Mandate</label>
                    {{ form.sdd_mandate.errors }}
                </div>
                <p class="text-sm text-gray-500">SEPA Direct Debit payments may take 2-3 business days to process.</p>
            </div>
            <button type="submit" class="btn btn-primary w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded">Submit Payment</button>
        </form>
    {% else %}
        <p class="mb-4">No recent order found. Please select products to order first.</p>
        <h3 class="text-lg font-semibold mb-2">Available Products</h3>
        <table class="w-full mb-4 border-collapse">
            <thead>
                <tr class="border-b bg-gray-100">
                    <th class="p-2 text-left">Product</th>
                    <th class="p-2 text-left">Price</th>
                    <th class="p-2 text-left">Stock</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                    <tr class="border-b">
                        <td class="p-2">
                            <a href="{% url 'product_detail' pk=product.pk %}" class="text-green-600 hover:underline">{{ product.name }}</a>
                        </td>
                        <td class="p-2">${{ product.price|floatformat:2 }}</td>
                        <td class="p-2">{{ product.stock }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="3" class="p-2 text-center">No products available.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <a href="{% url 'order_create' %}" class="btn btn-primary inline-block bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded">Select Products to Order</a>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentMethodRadios = document.querySelectorAll('input[name="payment_method"]');
    const cardFields = document.getElementById('card-fields');
    const bankTransferFields = document.getElementById('bank-transfer-fields');
    const sddFields = document.getElementById('sdd-fields');

    function toggleFields() {
        cardFields.classList.add('hidden');
        bankTransferFields.classList.add('hidden');
        sddFields.classList.add('hidden');

        const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
        if (selectedMethod === 'stripe' || selectedMethod === 'paypal') {
            cardFields.classList.remove('hidden');
        } else if (selectedMethod === 'bank_transfer') {
            bankTransferFields.classList.remove('hidden');
        } else if (selectedMethod === 'sdd') {
            sddFields.classList.remove('hidden');
        }
    }

    paymentMethodRadios.forEach(radio => {
        radio.addEventListener('change', toggleFields);
    });

    toggleFields(); // Initialize based on default or preselected payment method
});
</script>
{% endblock %}